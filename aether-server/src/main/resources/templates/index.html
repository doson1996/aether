<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Aether 任务调度系统</title>
    <link rel="icon" type="image/x-icon" th:href="@{/favicon.ico}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<div id="app">
    <div class="container-fluid">
        <!-- 导航栏 -->
        <div th:replace="~{fragments :: navbar(currentPage='index')}"></div>

        <!-- 主要内容 -->
        <div class="container mt-4">
            <div class="row">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="bi bi-list-task"></i> 任务列表</h2>
                        <div class="d-flex align-items-center">
                            <el-input-number
                                    v-model="refreshIntervalValue"
                                    :min="5"
                                    :max="300"
                                    :step="5"
                                    size="small"
                                    class="me-2"            style="width: 120px"
                                    @change="updateRefreshInterval">
                            </el-input-number>
                            <span class="me-2 text-muted" style="font-size: 14px;">秒</span>
                            <el-switch
                                    v-model="autoRefresh"
                                    @change="toggleAutoRefresh"
                                    active-text="自动刷新"
                                    :active-icon="Refresh"
                                    size="small"
                                    class="me-2">
                            </el-switch>
                            <el-button type="primary" @click="loadJobs" :icon="Refresh" circle>刷新</el-button>
                        </div>
                    </div>

                    <!-- 任务统计卡片 -->
                    <div class="row mb-4">
                        <div class="col-md-2">
                            <el-card class="text-white bg-primary">
                                <div class="card-body">
                                    <h5 class="card-title">总任务数</h5>
                                    <h2>{{ statistics.total }}</h2>
                                </div>
                            </el-card>
                        </div>
                        <div class="col-md-2">
                            <el-card class="text-white bg-secondary">
                                <div class="card-body">
                                    <h5 class="card-title">未执行</h5>
                                    <h2>{{ statistics.notExecuted }}</h2>
                                </div>
                            </el-card>
                        </div>
                        <div class="col-md-2">
                            <el-card class="text-white bg-info">
                                <div class="card-body">
                                    <h5 class="card-title">运行中</h5>
                                    <h2>{{ statistics.running }}</h2>
                                </div>
                            </el-card>
                        </div>
                        <div class="col-md-2">
                            <el-card class="text-white bg-success">
                                <div class="card-body">
                                    <h5 class="card-title">已完成</h5>
                                    <h2>{{ statistics.completed }}</h2>
                                </div>
                            </el-card>
                        </div>
                        <div class="col-md-2">
                            <el-card class="text-white bg-warning">
                                <div class="card-body">
                                    <h5 class="card-title">调度中</h5>
                                    <h2>{{ statistics.scheduling }}</h2>
                                </div>
                            </el-card>
                        </div>
                        <div class="col-md-2">
                            <el-card class="text-white bg-danger">
                                <div class="card-body">
                                    <h5 class="card-title">异常任务</h5>
                                    <h2>{{ statistics.error }}</h2>
                                </div>
                            </el-card>
                        </div>
                    </div>

                    <!-- 任务表格 -->
                    <el-card>
                        <el-table :data="jobs" style="width: 100%" v-loading="loading">
                            <el-table-column prop="appName" label="应用名" width="150"></el-table-column>
                            <el-table-column prop="jobName" label="任务名称" width="200"></el-table-column>
                            <!--                            <el-table-column prop="jobParams" label="任务参数" width="150"></el-table-column>-->
                            <!--                            <el-table-column prop="jobDescription" label="任务描述" width="100"></el-table-column>-->
                            <el-table-column label="调度中" width="100">
                                <template #default="scope">
                                    <el-tag>
                                        {{ getSchedulingText(scope.row.scheduling) }}
                                    </el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column label="任务类型" width="100">
                                <template #default="scope">
                                    <el-tag>
                                        {{ getJobTypeText(scope.row.jobType) }}
                                    </el-tag>
                                </template>
                            </el-table-column>

                            <!--                            <el-table-column prop="className" label="执行类" width="150"></el-table-column>-->
                            <el-table-column prop="cronExpression" label="Cron表达式" width="100"></el-table-column>
                            <el-table-column label="状态" width="150">
                                <template #default="scope">
                                    <el-tag :type="getJobStatusType(scope.row.status)">
                                        {{ getJobStatusText(scope.row.status) }}
                                    </el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column label="操作" width="350">
                                <template #default="scope">
                                    <el-button-group>
                                        <el-button
                                                size="small"
                                                type="primary"
                                                @click="viewJobDetail(scope.row)">
                                            查看
                                        </el-button>
                                        <el-button
                                                size="small"
                                                type="primary"
                                                @click="editJob(scope.row)">
                                            编辑
                                        </el-button>
                                        <el-button
                                                size="small"
                                                type="primary"
                                                :icon="Delete"
                                                @click="operateJob(scope.row.jobName, 'start')"
                                                :disabled="scope.row.status === 1">
                                            执行
                                        </el-button>
                                        <el-button
                                                size="small"
                                                type="primary"
                                                :icon="Delete"
                                                @click="operateJob(scope.row.jobName, 'schedule')"
                                                :disabled="scope.row.status === 1 || scope.row.scheduling === 1">
                                            调度
                                        </el-button>
                                        <el-button
                                                size="small"
                                                type="warning"
                                                :icon="Delete"
                                                @click="operateJob(scope.row.jobName, 'cancel')"
                                                :disabled="scope.row.status === 0">
                                            取消
                                        </el-button>
                                        <el-button
                                                size="small"
                                                type="danger"
                                                :icon="Delete"
                                                @click="operateJob(scope.row.jobName, 'delete')">
                                            删除
                                        </el-button>
                                    </el-button-group>
                                </template>
                            </el-table-column>
                        </el-table>

                        <!-- 分页组件 -->
                        <div class="mt-3 d-flex justify-content-center">
                            <el-pagination
                                    v-model:current-page="pagination.currentPage"
                                    v-model:page-size="pagination.pageSize"
                                    :page-sizes="[10, 20, 50, 100]"
                                    :small="false"
                                    :disabled="false"
                                    :background="true"
                                    layout="total, sizes, prev, pager, next, jumper"
                                    :total="pagination.total"
                                    @size-change="handleSizeChange"
                                    @current-change="handleCurrentChange"
                            />
                        </div>

                        <!-- 空状态提示 -->
                        <div v-if="jobs.length === 0 && !loading" class="text-center py-5">
                            <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
                            <h4 class="mt-3">暂无任务</h4>
                            <p>点击下方按钮添加新任务</p>
                            <el-button type="primary" @click="goToAddJob">
                                <i class="bi bi-plus-circle"></i> 添加任务
                            </el-button>
                        </div>
                    </el-card>

                    <!-- 执行器列表 -->
                    <div class="row mt-5">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2><i class="bi bi-cpu"></i> 执行器列表</h2>
                                <el-button type="primary" @click="loadExecutors" :icon="Refresh" circle>刷新</el-button>
                            </div>

                            <el-card>
                                <el-table :data="executors" style="width: 100%" v-loading="executorLoading">
                                    <el-table-column prop="appName" label="应用名称" width="150"></el-table-column>
                                    <el-table-column prop="name" label="执行器名称" width="300"></el-table-column>
                                    <el-table-column prop="host" label="地址" width="150"></el-table-column>
                                    <el-table-column prop="status" label="状态" width="120">
                                        <template #default="scope">
                                            <el-tag :type="getExecutorStatusType(scope.row.status)">
                                                {{ getExecutorStatusText(scope.row.status) }}
                                            </el-tag>
                                        </template>
                                    </el-table-column>
                                    <el-table-column label="操作" width="150">
                                        <template #default="scope">
                                            <el-button size="small" type="primary"
                                                       @click="viewExecutorDetail(scope.row)">
                                                查看详情
                                            </el-button>
                                        </template>
                                    </el-table-column>
                                </el-table>

                                <!-- 执行器分页组件 -->
                                <div class="mt-3 d-flex justify-content-center">
                                    <el-pagination
                                            v-model:current-page="executorPagination.currentPage"
                                            v-model:page-size="executorPagination.pageSize"
                                            :page-sizes="[10, 20, 50, 100]"
                                            :small="false"
                                            :disabled="false"
                                            :background="true"
                                            layout="total, sizes, prev, pager, next, jumper"
                                            :total="executorPagination.total"
                                            @size-change="handleExecutorSizeChange"
                                            @current-change="handleExecutorCurrentChange"
                                    />
                                </div>

                                <!-- 空状态提示 -->
                                <div v-if="executors.length === 0 && !executorLoading" class="text-center py-5">
                                    <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
                                    <h4 class="mt-3">暂无执行器</h4>
                                    <p>当前没有执行器注册到调度中心</p>
                                </div>
                            </el-card>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 执行器详情对话框 -->
    <el-dialog v-model="executorDetailDialogVisible" title="执行器详情" width="50%">
        <el-form :model="selectedExecutor" label-width="120px">
            <el-form-item label="应用名称:">
                <span>{{ selectedExecutor.appName }}</span>
            </el-form-item>
            <el-form-item label="执行器名称:">
                <span>{{ selectedExecutor.name }}</span>
            </el-form-item>
            <el-form-item label="地址:">
                <span>{{ selectedExecutor.host }}</span>
            </el-form-item>
            <el-form-item label="状态:">
                <el-tag :type="getExecutorStatusType(selectedExecutor.status)">
                    {{ getExecutorStatusText(selectedExecutor.status) }}
                </el-tag>
            </el-form-item>
            <el-form-item label="注册时间:">
                <span>{{ selectedExecutor.registerTime }}</span>
            </el-form-item>
            <el-form-item label="最后心跳时间:">
                <span>{{ selectedExecutor.lastHeartbeat }}</span>
            </el-form-item>
            <el-form-item label="权重:">
                <span>{{ selectedExecutor.weight }}</span>
            </el-form-item>
        </el-form>
    </el-dialog>

    <!-- 在执行器详情对话框后面添加任务详情对话框 -->
    <el-dialog v-model="jobDetailDialogVisible" title="任务详情" width="60%">
        <el-form :model="selectedJob" label-width="120px">
            <el-row>
                <el-col :span="12">
                    <el-form-item label="应用名:">
                        <span>{{ selectedJob.appName }}</span>
                    </el-form-item>
                </el-col>
                <el-col :span="12">
                    <el-form-item label="任务名称:">
                        <span>{{ selectedJob.jobName }}</span>
                    </el-form-item>
                </el-col>
            </el-row>

            <el-row>
                <el-col :span="12">
                    <el-form-item label="任务描述:">
                        <span>{{ selectedJob.jobDescription || '无' }}</span>
                    </el-form-item>
                </el-col>
                <el-col :span="12">
                    <el-form-item label="任务参数:">
                        <span>{{ selectedJob.jobParams || '无' }}</span>
                    </el-form-item>
                </el-col>
            </el-row>

            <el-row>
                <el-col :span="12">
                    <el-form-item label="任务类型:">
                        <el-tag>{{ getJobTypeText(selectedJob.jobType) }}</el-tag>
                    </el-form-item>
                </el-col>
                <el-col :span="12">
                    <el-form-item label="状态:">
                        <el-tag :type="getJobStatusType(selectedJob.status)">
                            {{ getJobStatusText(selectedJob.status) }}
                        </el-tag>
                    </el-form-item>
                </el-col>
            </el-row>

            <el-row>
                <el-col :span="12">
                    <el-form-item label="是否调度中:">
                        <el-tag>{{ getSchedulingText(selectedJob.scheduling) }}</el-tag>
                    </el-form-item>
                </el-col>
                <el-col :span="12">
                    <el-form-item label="Cron表达式:">
                        <span>{{ selectedJob.cronExpression || '无' }}</span>
                    </el-form-item>
                </el-col>
            </el-row>

            <el-row>
                <el-col :span="12">
                    <el-form-item label="执行类:">
                        <span>{{ selectedJob.className || '无' }}</span>
                    </el-form-item>
                </el-col>
                <el-col :span="12">
                    <el-form-item label="方法名:">
                        <span>{{ selectedJob.methodName || '无' }}</span>
                    </el-form-item>
                </el-col>
            </el-row>

            <el-form-item label="创建时间:">
                <span>{{ selectedJob.createTime || '无' }}</span>
            </el-form-item>

            <el-form-item label="更新时间:">
                <span>{{ selectedJob.updateTime || '无' }}</span>
            </el-form-item>

            <el-form-item v-if="selectedJob.lastExecuteTime" label="最后执行时间:">
                <span>{{ selectedJob.lastExecuteTime }}</span>
            </el-form-item>

            <el-form-item v-if="selectedJob.nextExecuteTime" label="下次执行时间:">
                <span>{{ selectedJob.nextExecuteTime }}</span>
            </el-form-item>
        </el-form>

        <template #footer>
        <span class="dialog-footer">
            <el-button @click="jobDetailDialogVisible = false">关闭</el-button>
        </span>
        </template>
    </el-dialog>

    <!-- 操作结果提示 -->
    <el-message v-for="message in messages" :key="message.id"
                :type="message.type"
                :message="message.content"
                show-close>
    </el-message>
</div>

<script th:inline="javascript">
    const {createApp, ref, onMounted, onBeforeUnmount, reactive} = Vue;
    const {ElMessage, ElMessageBox} = ElementPlus;
    const {Delete, Refresh, VideoPlay, VideoPause} = ElementPlus;

    // API基础URL配置
    const API_BASE_URL = /*[[@{/}]]*/ 'http://localhost:23843';

    createApp({
        setup() {
            const jobs = ref([]);
            const executors = ref([]); // 执行器列表
            const loading = ref(false);
            const executorLoading = ref(false); // 执行器加载状态
            const messages = ref([]);
            const statistics = ref({
                total: 0,
                notExecuted: 0,
                running: 0,
                cancel: 0,
                error: 0,
                completed: 0
            });

            // 编辑任务
            const editJob = (job) => {
                window.location.href = `/api/page/edit-job?jobName=${job.jobName}`;
            };

            // 执行器详情对话框
            const executorDetailDialogVisible = ref(false);
            const selectedExecutor = ref({});

            // 任务详情对话框
            const jobDetailDialogVisible = ref(false);
            const selectedJob = ref({});


            // 任务分页信息
            const pagination = reactive({
                currentPage: 1,
                pageSize: 10,
                total: 0
            });

            // 执行器分页信息
            const executorPagination = reactive({
                currentPage: 1,
                pageSize: 10,
                total: 0
            });

            let refreshInterval = null;

            const refreshIntervalValue = ref(10); // 默认10秒

            // 开始定时刷新
            const startAutoRefresh = () => {
                // 先清除已存在的定时器
                stopAutoRefresh();
                // 设置新的定时器，根据用户配置的时间间隔刷新
                if (refreshIntervalValue.value > 0) {
                    refreshInterval = setInterval(() => {
                        loadJobs();
                        loadExecutors();
                    }, refreshIntervalValue.value * 1000);
                }
            };

            // 添加更新刷新间隔的函数
            const updateRefreshInterval = (value) => {
                if (autoRefresh.value) {
                    // 如果当前正在自动刷新，重新启动定时器
                    startAutoRefresh();
                }
            };

            // 停止定时刷新
            const stopAutoRefresh = () => {
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                }
            };

            // 在 onMounted 中启动定时刷新
            onMounted(() => {
                loadJobs();
                loadExecutors();
                // 只在自动刷新开启时启动定时器
                if (autoRefresh.value) {
                    startAutoRefresh();
                }
            });

            // 添加一个组件卸载前的清理函数
            onBeforeUnmount(() => {
                stopAutoRefresh(); // 清除定时器
            });

            // 在 setup() 中添加响应式变量和方法
            const autoRefresh = ref(true);

            const toggleAutoRefresh = (value) => {
                if (value) {
                    startAutoRefresh();
                } else {
                    stopAutoRefresh();
                }
            };

            // 加载任务列表
            const loadJobs = async () => {
                loading.value = true;
                try {
                    console.log('加载任务列表...')
                    const response = await axios.post(`${API_BASE_URL}job-info/page`, {
                        pageNum: pagination.currentPage,
                        pageSize: pagination.pageSize
                    });
                    if (response.data.success) {
                        jobs.value = response.data.data.data || [];
                        pagination.total = response.data.data.total || 0;
                        updateStatistics();
                    } else {
                        showMessage('获取任务列表失败: ' + response.data.message, 'error');
                    }
                } catch (error) {
                    console.error('加载任务失败:', error);
                    showMessage('加载任务失败: ' + error.message, 'error');
                } finally {
                    loading.value = false;
                }
            };

            // 加载执行器列表
            const loadExecutors = async () => {
                executorLoading.value = true;
                try {
                    const response = await axios.post(`${API_BASE_URL}executor/page`, {
                        pageNum: executorPagination.currentPage,
                        pageSize: executorPagination.pageSize
                    });
                    if (response.data.success) {
                        executors.value = response.data.data.data || [];
                        executorPagination.total = response.data.data.total || 0;
                    } else {
                        showMessage('获取执行器列表失败: ' + response.data.message, 'error');
                    }
                } catch (error) {
                    console.error('加载执行器失败:', error);
                    showMessage('加载执行器失败: ' + error.message, 'error');
                } finally {
                    executorLoading.value = false;
                }
            };

            // 更新统计信息
            const updateStatistics = async () => {
                const response = await axios.get(`${API_BASE_URL}job-info/statistics`);
                if (response.data.success) {
                    const statisticsData = response.data.data;
                    statistics.value.total = statisticsData.total;
                    // 实际项目中应该从后端获取准确统计信息
                    statistics.value.notExecuted = statisticsData.notExecuted || 0;
                    statistics.value.running = statisticsData.running || 0;
                    statistics.value.completed = statisticsData.completed || 0;
                    statistics.value.error = statisticsData.error || 0;
                    statistics.value.scheduling = statisticsData.scheduling || 0;
                } else {
                    showMessage('获取统计信息失败: ' + response.data.message, 'error');
                }
            };

            // 获取任务状态对应的标签类型
            const getJobStatusType = (status) => {
                switch (status) {
                    case 1:
                        return 'success';  // 运行中
                    case 0:
                        return 'warning';  // 已暂停
                    case 3:
                        return 'error';
                    default:
                        return 'info';
                }
            };

            // 获取任务状态文本
            const getJobStatusText = (status) => {
                switch (status) {
                    case 0:
                        return '未执行';
                    case 1:
                        return '运行中';
                    case 2:
                        return '运行完成';
                    case 3:
                        return '执行异常';
                    case 4:
                        return '已取消';
                    case 5:
                        return '禁用';
                    default:
                        return '未知';
                }
            };

            const getJobTypeText = (type) => {
                switch (type) {
                    case '1':
                        return 'cron';
                    case '2':
                        return '定时任务';
                    case '3':
                        return 'http';
                    case '4':
                        return 'shell';
                    case '5':
                        return 'java';
                    default:
                        return '未知';
                }
            }

            const getSchedulingText = (scheduling) => {
                switch (scheduling) {
                    case 1:
                        return '是';
                    default:
                        return '否';
                }
            }

            // 获取执行器状态对应的标签类型
            const getExecutorStatusType = (status) => {
                switch (status) {
                    case 1:
                        return 'success';  // 在线
                    case 0:
                        return 'danger';   // 离线
                    default:
                        return 'info';
                }
            };

            // 获取执行器状态文本
            const getExecutorStatusText = (status) => {
                switch (status) {
                    case 0:
                        return '离线';
                    case 1:
                        return '在线';
                    default:
                        return '未知';
                }
            };

            // 查看执行器详情
            const viewExecutorDetail = (executor) => {
                selectedExecutor.value = executor;
                executorDetailDialogVisible.value = true;
            };

            // 查看任务详情
            const viewJobDetail = (job) => {
                selectedJob.value = job;
                jobDetailDialogVisible.value = true;
            };

            // 操作任务（启动、暂停、删除）
            const operateJob = async (jobName, operation) => {
                if (!jobName) return;

                // 删除操作需要确认
                if (operation === 'delete') {
                    try {
                        await ElMessageBox.confirm(`确定要删除任务 "${jobName}" 吗？`, '提示', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning',
                        });
                    } catch {
                        return; // 用户取消操作
                    }
                }

                const url = `${API_BASE_URL}job-info/${operation}/${jobName}`;
                const method = operation === 'delete' ? 'delete' : 'post';

                try {
                    const response = await axios({method, url});
                    if (response.data.success) {
                        showMessage(`${response.data.message}`, 'success');
                        loadJobs(); // 重新加载任务列表
                    } else {
                        // showMessage(`任务${operation === 'start' ? '启动' : operation === 'cancel' ? '取消' : '删除'}失败: ${response.data.message}`, 'error');
                        showMessage(`${response.data.message}`, 'error');
                    }
                } catch (error) {
                    showMessage(`请求失败: ${error.message}`, 'error');
                }
            };

            // 显示操作结果消息
            const showMessage = (content, type) => {
                ElMessage({
                    message: content,
                    type: type,
                    showClose: true,
                    duration: 3000
                });
            };

            // 跳转到添加任务页面
            const goToAddJob = () => {
                window.location.href = '/api/page/add-job';
            };

            // 处理任务页面大小变化
            const handleSizeChange = (val) => {
                pagination.pageSize = val;
                pagination.currentPage = 1;
                loadJobs();
            };

            // 处理任务当前页变化
            const handleCurrentChange = (val) => {
                pagination.currentPage = val;
                loadJobs();
            };

            // 处理执行器页面大小变化
            const handleExecutorSizeChange = (val) => {
                executorPagination.pageSize = val;
                executorPagination.currentPage = 1;
                loadExecutors();
            };

            // 处理执行器当前页变化
            const handleExecutorCurrentChange = (val) => {
                executorPagination.currentPage = val;
                loadExecutors();
            };

            // 页面加载完成后获取任务列表和执行器列表
            onMounted(() => {
                loadJobs();
                loadExecutors();
            });

            return {
                jobs,
                jobDetailDialogVisible,
                selectedJob,
                editJob,
                viewJobDetail,
                executors,
                loading,
                executorLoading,
                messages,
                statistics,
                pagination,
                executorPagination,
                executorDetailDialogVisible,
                selectedExecutor,
                loadJobs,
                loadExecutors,
                getJobStatusType,
                getJobStatusText,
                getJobTypeText,
                getSchedulingText,
                getExecutorStatusType,
                getExecutorStatusText,
                viewExecutorDetail,
                operateJob,
                goToAddJob,
                handleSizeChange,
                handleCurrentChange,
                handleExecutorSizeChange,
                handleExecutorCurrentChange,
                refreshIntervalValue,
                updateRefreshInterval,
                autoRefresh,
                toggleAutoRefresh,
                Delete,
                Refresh,
                VideoPlay,
                VideoPause
            };
        }
    }).use(ElementPlus).mount('#app');
</script>


</body>
</html>
