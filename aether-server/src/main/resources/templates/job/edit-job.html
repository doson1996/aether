<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>编辑任务 - Aether 任务调度系统</title>
    <div th:replace="~{common/css :: css}"></div>
</head>
<body>
<div id="app">
    <div class="container-fluid">
        <!-- 导航栏 -->
        <div th:replace="~{fragments :: navbar(currentPage='edit-job')}"></div>

        <!-- 主要内容 -->
        <div class="container mt-4">
            <div class="row">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="bi bi-pencil-square"></i> 编辑任务</h2>
                        <el-button type="primary" @click="goToIndex">返回任务列表</el-button>
                    </div>

                    <el-card>
                        <el-form :model="jobForm" :rules="rules" ref="jobFormRef" label-width="120px">
                            <el-row :gutter="20">
                                <el-col :span="12">
                                    <el-form-item label="应用名" prop="appName">
                                        <el-input v-model="jobForm.appName"></el-input>
                                    </el-form-item>
                                </el-col>
                                <el-col :span="12">
                                    <el-form-item label="任务名称" prop="jobName">
                                        <el-input v-model="jobForm.jobName" disabled></el-input>
                                    </el-form-item>
                                </el-col>
                            </el-row>

                            <el-row :gutter="20">
                                <el-col :span="12">
                                    <el-form-item label="任务描述" prop="jobDescription">
                                        <el-input v-model="jobForm.jobDescription"
                                                  placeholder="请输入任务描述"></el-input>
                                    </el-form-item>
                                </el-col>
                                <el-col :span="12">
                                    <el-form-item label="任务类型" prop="jobType">
                                        <el-select v-model="jobForm.jobType" placeholder="请选择任务类型"
                                                   style="width: 100%">
                                            <el-option label="Cron" value="1"></el-option>
                                            <el-option label="定时任务" value="2"></el-option>
                                            <el-option label="HTTP" value="3"></el-option>
                                            <el-option label="Shell" value="4"></el-option>
                                            <el-option label="Java" value="5"></el-option>
                                        </el-select>
                                    </el-form-item>
                                </el-col>
                            </el-row>

                            <el-row :gutter="20">
                                <el-col :span="12">
                                    <el-form-item v-if="jobForm.jobType === '1'" label="Cron表达式" prop="cronExpression">
                                        <el-input v-model="jobForm.cronExpression"
                                                  placeholder="请输入Cron表达式"></el-input>
                                    </el-form-item>
                                    <el-form-item v-if="jobForm.jobType === '5'" label="执行类" prop="className">
                                        <el-input v-model="jobForm.className"
                                                  placeholder="请输入执行类全限定名"></el-input>
                                    </el-form-item>

                                    <el-form-item  v-if="jobForm.jobType === '3'"  label="http链接" prop="className">
                                        <el-input v-model="jobForm.httpUrl" placeholder="请输入http链接"></el-input>
                                    </el-form-item>
                                </el-col>
                            </el-row>

                            <el-row :gutter="20">
                                <el-col :span="12">
                                    <el-form-item label="任务参数" prop="jobParams">
                                        <el-input v-model="jobForm.jobParams" placeholder="请输入任务参数"></el-input>
                                    </el-form-item>
                                </el-col>
                            </el-row>

<!--                            <el-form-item label="状态">-->
<!--                                <el-switch-->
<!--                                        v-model="jobForm.status"-->
<!--                                        :active-value="0"-->
<!--                                        :inactive-value="5"-->
<!--                                        active-text="启用"-->
<!--                                        inactive-text="禁用">-->
<!--                                </el-switch>-->
<!--                            </el-form-item>-->

                            <el-form-item>
                                <el-button type="primary" @click="submitForm">保存</el-button>
                                <el-button @click="resetForm">重置</el-button>
                                <el-button @click="goToIndex">取消</el-button>
                            </el-form-item>
                        </el-form>
                    </el-card>
                </div>
            </div>
        </div>
    </div>

    <!-- 操作结果提示 -->
    <el-message v-for="message in messages" :key="message.id"
                :type="message.type"
                :message="message.content"
                show-close>
    </el-message>

    <!-- 引入JS片段 -->
    <div th:replace="~{common/js :: js}"></div>
</div>

<script th:inline="javascript">
    const {createApp, ref, onMounted} = Vue;
    const {ElMessage, ElMessageBox} = ElementPlus;

    // API基础URL配置
    const API_BASE_URL = /*[[@{/}]]*/ 'http://localhost:23843';

    createApp({
        setup() {
            const jobFormRef = ref();
            const messages = ref([]);
            const jobForm = ref({
                appName: '',
                jobName: '',
                jobDescription: '',
                jobType: '',
                cronExpression: '',
                className: '',
                jobParams: ''
            });

            const rules = {
                appName: [
                    {required: true, message: '请输入应用名', trigger: 'blur'}
                ],
                jobName: [
                    {required: true, message: '请输入任务名称', trigger: 'blur'}
                ],
                jobType: [
                    {required: true, message: '请选择任务类型', trigger: 'change'}
                ],
                cronExpression: [
                    { required: true, message: '请输入Cron表达式', trigger: 'blur' }
                ],
                className: [
                    {required: true, message: '请输入执行类', trigger: 'blur'}
                ],
                httpUrl: [
                    { required: true, message: '请输入httpUrl', trigger: 'blur' }
                ],
            };

            // 获取URL参数
            const getUrlParameter = (name) => {
                name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
                const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
                const results = regex.exec(window.location.href);
                return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
            };

            // 加载任务详情
            const loadJobDetail = async () => {
                const jobName = getUrlParameter('jobName');
                if (!jobName) {
                    showMessage('未指定任务名称', 'error');
                    return;
                }

                try {
                    const response = await axios.get(`${API_BASE_URL}job-info/detail/${jobName}`);
                    if (response.data.success) {
                        const jobData = response.data.data;
                        jobForm.value = {
                            ...jobData,
                            status: jobData.status || 1
                        };
                    } else {
                        showMessage('获取任务详情失败: ' + response.data.message, 'error');
                    }
                } catch (error) {
                    console.error('加载任务详情失败:', error);
                    showMessage('加载任务详情失败: ' + error.message, 'error');
                }
            };

            // 提交表单
            const submitForm = async () => {
                if (!jobFormRef.value) return;

                await jobFormRef.value.validate(async (valid) => {
                    if (valid) {
                        try {
                            const response = await axios.post(`${API_BASE_URL}job-info/saveOrUpdate`, jobForm.value);
                            if (response.data.success) {
                                showMessage('任务更新成功！', 'success');
                                setTimeout(() => {
                                    goToIndex();
                                }, 1000);
                            } else {
                                showMessage('任务更新失败: ' + response.data.message, 'error');
                            }
                        } catch (error) {
                            showMessage('请求失败: ' + error.message, 'error');
                        }
                    } else {
                        showMessage('请检查表单填写是否正确', 'warning');
                    }
                });
            };

            // 重置表单
            const resetForm = () => {
                jobFormRef.value.resetFields();
            };

            // 返回任务列表
            const goToIndex = () => {
                window.location.href = '/api/page/';
            };

            // 显示操作结果消息
            const showMessage = (content, type) => {
                ElMessage({
                    message: content,
                    type: type,
                    showClose: true,
                    duration: 3000
                });
            };

            // 页面加载完成后获取任务详情
            onMounted(() => {
                loadJobDetail();
            });

            return {
                jobFormRef,
                messages,
                jobForm,
                rules,
                submitForm,
                resetForm,
                goToIndex
            };
        }
    }).use(ElementPlus).mount('#app');
</script>
</body>
</html>
